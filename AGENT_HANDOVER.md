# AGENT HANDOVER: NH3 GCMC Simulation — GCP Deployment

## Quick Start (One Command)

```bash
cd ~/GCMC
chmod +x setup_and_run.sh
./setup_and_run.sh                              # Install + test + run 1 MOF
./setup_and_run.sh --max_mofs=50                # Run 50 MOFs sequentially
./setup_and_run.sh --max_mofs=100 --parallel --ncpu=8  # 100 MOFs, 8 workers
./setup_and_run.sh --skip-install --max_mofs=10 # Skip install on re-runs
```

Environment variables also work:
```bash
MAX_MOFS=200 MODE=air_removal PARALLEL=true NCPU=16 ./setup_and_run.sh --skip-install
```

---

## What setup_and_run.sh Does (7 Steps)

| Step | Action |
|------|--------|
| 1 | `pip install` RASPA2, PACMOF2, pymatgen, openbabel, etc. |
| 2 | Verify `simulate` binary and PACMOF2 import |
| 3 | Copy `Ammonia.def` / `H2O.def` into RASPA's molecule directory |
| 4 | Convert all `.def` files from CRLF → LF |
| 5 | Write `.env` with auto-detected RASPA path |
| 6 | Smoke test: run RASPA on ABEXIQ.cif (10 cycles) to confirm everything works |
| 7 | Run the actual GCMC screening via `gcmc_screen_nh3.py` |

---

## Project Structure

```
GCMC/
├── setup_and_run.sh            ← START HERE — one-command setup + run
├── gcmc_screen_nh3.py          ← CLI entry point for batch screening
├── nh3_simulation.py           ← Pure NH3 / air-removal simulation logic
├── gcmc_wrapper_nh3.py         ← Core RASPA2 wrapper (charges, HVF, GCMC)
├── validate_nh3_uptake.py      ← Compare results vs reference dataset
├── validate_charges.py         ← PACMOF2 vs MEPO-Qeq comparison
├── force_field/                ← Local force field files (109 atom types)
│   ├── force_field.def
│   ├── force_field_mixing_rules.def   ← Has lennard-jones keyword (CRITICAL)
│   └── pseudo_atoms.def
├── molecule_definitions/TraPPE/
│   ├── Ammonia.def             ← 4-site TraPPE-EH ammonia
│   ├── H2O.def                 ← TIP4P/2005 water
│   └── N2.def                  ← TraPPE nitrogen
├── raw_nh3_core/
│   ├── nh3_core_structured.csv ← 1030 MOFs with reference NH3 uptakes
│   └── cifs/                   ← CIF files for all 1030 MOFs
└── .env                        ← Auto-generated by setup_and_run.sh
```

---

## Simulation Pipeline (Per MOF)

```
CIF file (e.g. ABEXIQ.cif — already has DDEC6 charges from PACMAN)
  │
  ├─ PACMOF2 recalculates DDEC6 charges → writes {MOF}_pacmof.cif
  │
  ├─ Charge neutrality check (|net charge| ≤ 0.05 e)
  │
  ├─ Helium void fraction via Widom insertion (10,000 cycles)
  │
  ├─ Unit cell replication (min-image convention, cutoff=12 Å)
  │
  └─ GCMC: 20,000 eq + 20,000 prod cycles
       │
       └─ Output: NH3 uptake (mmol/g), Qst (kJ/mol), block SE
```

---

## Simulation Modes

| Mode | Command | Conditions |
|------|---------|-----------|
| **pure** | `--mode pure` | 100% NH3, 1 bar, 298 K |
| **air_removal** | `--mode air_removal` | Adsorption: NH3/H2O/N2 @ 298K, 1bar → Desorption: pure NH3 @ 400K, 0.01bar |

---

## Output Format

Results are saved to `raw_nh3_core/gcmc_runs/nh3_{mode}_results.json`:

```json
[
  {
    "uid": "ABEXIQ",
    "info": "success",
    "results": {
      "NH3_uptake_mmol_g": 8.1234,
      "NH3_heat_of_adsorption_kJ_mol": 42.5,
      "NH3_uptake_se_mmol_g": 0.15
    }
  }
]
```

---

## Validation Run

After screening, validate against the reference dataset:

```bash
python3 validate_nh3_uptake.py --n_mofs 5 --charge_method pacmof2
```

This picks MOFs from low/mid/high uptake ranges and reports per-MOF error %.

---

## Known Issues & Fixes (Already Applied)

### 1. force_field_mixing_rules.def — MUST have `lennard-jones` keyword
**Symptom:** RASPA prints `unknown: 1.000` for every atom, then `ReturnPseudoAtomNumber: Error!!!!`
**Root cause:** Each line needs the format: `AtomType  lennard-jones  epsilon  sigma`
**Status:** FIXED in the repo.

### 2. Windows CRLF line endings
**Symptom:** RASPA crashes parsing `109\r` as atom count
**Fix:** `setup_and_run.sh` runs `sed -i 's/\r$//'` on all `.def` files automatically.

### 3. Ammonia.def not in RASPA's molecule directory
**Symptom:** `Cannot open .../molecules/TraPPE/Ammonia.def`
**Fix:** `setup_and_run.sh` copies it automatically in Step 3.

### 4. CIF files already have charges
The CIFs in `raw_nh3_core/cifs/` already contain DDEC6 charges from PACMAN.
PACMOF2 re-predicts charges anyway (writes `_pacmof.cif`). This is fine — the pipeline
uses `UseChargesFromCIFFile yes` so RASPA reads charges from whichever CIF it gets.

---

## Manual Python Usage (Alternative to CLI)

```python
from nh3_simulation import nh3_uptake_pure

result = nh3_uptake_pure(
    "raw_nh3_core/cifs/ABEXIQ.cif",
    calc_charges=True,
    charge_method="pacmof2",
    temperature=298,
    pressure=100000,
)
print(f"NH3 uptake: {result['NH3_uptake_mmol_g']:.4f} mmol/g")
```

---

## GCP Recommendations

- **Machine type:** `e2-standard-4` (4 vCPU, 16 GB) for sequential, `e2-standard-16` for parallel
- **Disk:** 10 GB is sufficient
- **OS:** Ubuntu 22.04 LTS
- **Time estimate:** ~5–15 min per MOF (depends on cell size), ~100 MOFs/day on 8 cores
